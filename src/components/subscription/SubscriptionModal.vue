<!--
/**7. src/components/subscription/SubscriptionModal.vue
 * ğŸ¯ SubscriptionModal.vue - è®¢é˜…å‡çº§å¼¹çª—ç»„ä»¶
 * 
 * ğŸ“‹ åŠŸèƒ½æ¦‚è¿°:
 * - ç”¨æˆ·è®¢é˜…å‡çº§çš„æ¨¡æ€å¼¹çª—
 * - åŒ…å«è®¢é˜…è®¡åˆ’è¯¦æƒ…ã€æ”¯ä»˜è¡¨å•ã€è´¦å•ä¿¡æ¯
 * - Mockæ”¯ä»˜æµç¨‹ï¼Œæ¨¡æ‹ŸçœŸå®æ”¯ä»˜ä½“éªŒ
 * - æ”¯æŒè¡¨å•éªŒè¯å’Œé”™è¯¯å¤„ç†
 * - å“åº”å¼è®¾è®¡ï¼Œç§»åŠ¨ç«¯å‹å¥½
 * 
 * ğŸ¯ ä¸»è¦åŠŸèƒ½:
 * - è®¢é˜…è®¡åˆ’æ‘˜è¦å±•ç¤º
 * - ProåŠŸèƒ½ç‰¹æ€§åˆ—è¡¨
 * - Mockä¿¡ç”¨å¡æ”¯ä»˜è¡¨å•
 * - å¡å·ã€æœ‰æ•ˆæœŸã€CVCæ ¼å¼åŒ–
 * - å®æ—¶è¡¨å•éªŒè¯
 * - è´¦å•ä¿¡æ¯è®¡ç®—å’Œå±•ç¤º
 * - æ”¯ä»˜å¤„ç†çŠ¶æ€ç®¡ç†
 * - Demoæ¨¡å¼æç¤º
 * 
 * ğŸ“¡ Props:
 * - isOpen: boolean - å¼¹çª—æ˜¾ç¤ºçŠ¶æ€
 * - selectedPlan?: string - é€‰ä¸­çš„è®¢é˜…è®¡åˆ’
 * 
 * ğŸ”„ Emits:
 * - close: [] - å…³é—­å¼¹çª—äº‹ä»¶
 * - success: [] - è®¢é˜…æˆåŠŸäº‹ä»¶
 * 
 * ğŸ”— ä¾èµ–ç»„ä»¶:
 * - LoadingSpinner: åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨
 * 
 * ğŸ’³ æ”¯ä»˜åŠŸèƒ½:
 * - ä¿¡ç”¨å¡ä¿¡æ¯è¾“å…¥å’ŒéªŒè¯
 * - è‡ªåŠ¨æ ¼å¼åŒ–ï¼ˆå¡å·ç©ºæ ¼ã€æœ‰æ•ˆæœŸæ–œçº¿ï¼‰
 * - Mockæ”¯ä»˜å¤„ç†ï¼ˆ90%æˆåŠŸç‡ï¼‰
 * - æ”¯ä»˜æˆåŠŸ/å¤±è´¥å¤„ç†
 */
-->

<template>
  <!-- ğŸŒ€ Teleportåˆ°body - ç¡®ä¿å¼¹çª—åœ¨é¡¶å±‚æ˜¾ç¤º -->
  <Teleport to="body">
    <!-- ğŸ­ å¼¹çª—è¿‡æ¸¡åŠ¨ç”» -->
    <Transition name="modal">
      <div
        v-if="isOpen"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
        @click.self="$emit('close')"
      >
        <!-- ğŸ“± å¼¹çª—ä¸»ä½“ - å“åº”å¼è®¾è®¡ -->
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
          
          <!-- ğŸ“‹ å¼¹çª—å¤´éƒ¨ - å›ºå®šåœ¨é¡¶éƒ¨ -->
          <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 rounded-t-xl">
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-bold text-gray-900">
                Upgrade to Pro
              </h2>
              <!-- âŒ å…³é—­æŒ‰é’® -->
              <button
                @click="$emit('close')"
                class="text-gray-400 hover:text-gray-600 transition-colors"
              >
                <XMarkIcon class="w-6 h-6" />
              </button>
            </div>
          </div>

          <!-- ğŸ“‹ å¼¹çª—å†…å®¹åŒºåŸŸ -->
          <div class="px-6 py-6">
            
            <!-- ğŸ’ è®¢é˜…è®¡åˆ’æ‘˜è¦ -->
            <div class="bg-primary-50 rounded-lg p-4 mb-6">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-primary-900">Pro Monthly Plan</h3>
                <!-- ä»·æ ¼å±•ç¤º -->
                <div class="text-right">
                  <div class="text-2xl font-bold text-primary-900">$9.99</div>
                  <div class="text-sm text-primary-700">/month</div>
                </div>
              </div>
              
              <div class="text-sm text-primary-700">
                Unlock all premium features and take your English learning to the next level.
              </div>
            </div>

            <!-- âœ… ProåŠŸèƒ½ç‰¹æ€§åˆ—è¡¨ -->
            <div class="mb-6">
              <h4 class="font-medium text-gray-900 mb-3">What's included:</h4>
              <div class="space-y-2">
                <div 
                  v-for="feature in proFeatures" 
                  :key="feature"
                  class="flex items-center"
                >
                  <CheckIcon class="w-4 h-4 text-green-500 mr-2" />
                  <span class="text-sm text-gray-700">{{ feature }}</span>
                </div>
              </div>
            </div>

            <!-- ğŸ’³ æ”¯ä»˜æ–¹å¼è¡¨å• -->
            <div class="mb-6">
              <h4 class="font-medium text-gray-900 mb-3">Payment Method:</h4>
              
              <!-- ğŸ” Mockä¿¡ç”¨å¡è¡¨å• -->
              <div class="space-y-4">
                
                <!-- ä¿¡ç”¨å¡å·è¾“å…¥ -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Card Number
                  </label>
                  <input
                    v-model="paymentForm.cardNumber"
                    type="text"
                    placeholder="1234 5678 9012 3456"
                    class="input"
                    maxlength="19"
                    @input="formatCardNumber"
                  />
                </div>
                
                <!-- æœ‰æ•ˆæœŸå’ŒCVC -->
                <div class="grid grid-cols-2 gap-4">
                  <!-- æœ‰æ•ˆæœŸè¾“å…¥ -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                      Expiry
                    </label>
                    <input
                      v-model="paymentForm.expiry"
                      type="text"
                      placeholder="MM/YY"
                      class="input"
                      maxlength="5"
                      @input="formatExpiry"
                    />
                  </div>
                  <!-- CVCè¾“å…¥ -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                      CVC
                    </label>
                    <input
                      v-model="paymentForm.cvc"
                      type="text"
                      placeholder="123"
                      class="input"
                      maxlength="3"
                    />
                  </div>
                </div>

                <!-- æŒå¡äººå§“å -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Cardholder Name
                  </label>
                  <input
                    v-model="paymentForm.name"
                    type="text"
                    placeholder="Full name on card"
                    class="input"
                  />
                </div>
              </div>
            </div>

            <!-- ğŸ’° è´¦å•ä¿¡æ¯æ‘˜è¦ -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
              <div class="flex justify-between items-center text-sm mb-2">
                <span class="text-gray-600">Pro Monthly Plan</span>
                <span class="font-medium">$9.99</span>
              </div>
              <div class="flex justify-between items-center text-sm mb-2">
                <span class="text-gray-600">Tax</span>
                <span class="font-medium">$0.00</span>
              </div>
              <!-- æ€»ä»· -->
              <div class="border-t border-gray-200 pt-2">
                <div class="flex justify-between items-center">
                  <span class="font-semibold text-gray-900">Total</span>
                  <span class="font-bold text-gray-900">$9.99</span>
                </div>
              </div>
            </div>

            <!-- ğŸ“œ æœåŠ¡æ¡æ¬¾è¯´æ˜ -->
            <div class="text-xs text-gray-500 mb-6">
              By subscribing, you agree to our Terms of Service and acknowledge that 
              your subscription will renew automatically until cancelled. You can cancel 
              anytime from your account settings.
            </div>

            <!-- ğŸ¯ æ“ä½œæŒ‰é’®ç»„ -->
            <div class="space-y-3">
              <!-- è®¢é˜…ç¡®è®¤æŒ‰é’® -->
              <button
                @click="handleSubscribe"
                :disabled="isProcessing || !isPaymentFormValid"
                class="w-full btn-primary relative"
                :class="{ 
                  'opacity-50 cursor-not-allowed': isProcessing || !isPaymentFormValid
                }"
              >
                <!-- æ­£å¸¸çŠ¶æ€ -->
                <span v-if="!isProcessing">Subscribe Now</span>
                <!-- å¤„ç†ä¸­çŠ¶æ€ -->
                <div v-else class="flex items-center justify-center">
                  <LoadingSpinner size="small" color="white" />
                  <span class="ml-2">Processing...</span>
                </div>
              </button>

              <!-- å–æ¶ˆæŒ‰é’® -->
              <button
                @click="$emit('close')"
                class="w-full btn-outline"
                :disabled="isProcessing"
              >
                Cancel
              </button>
            </div>

            <!-- ğŸ® Demoæ¨¡å¼æç¤º -->
            <div class="mt-4 p-3 bg-blue-50 rounded-lg">
              <p class="text-sm text-blue-700">
                <strong>Demo Mode:</strong> This is a simulated payment. No real charges will be made.
              </p>
            </div>
          </div>
        </div>
      </div>
    </Transition>
  </Teleport>
</template>

<script setup lang="ts">
/**
 * ğŸ“ ç»„ä»¶é€»è¾‘
 * 
 * ğŸ¯ ä¸»è¦åŠŸèƒ½:
 * - ç®¡ç†æ”¯ä»˜è¡¨å•çŠ¶æ€å’ŒéªŒè¯
 * - å¤„ç†ä¿¡ç”¨å¡ä¿¡æ¯æ ¼å¼åŒ–
 * - æ‰§è¡ŒMockæ”¯ä»˜æµç¨‹
 * - å¤„ç†æ”¯ä»˜æˆåŠŸ/å¤±è´¥çŠ¶æ€
 */

import { ref, computed } from 'vue'
import { useSubscriptionStore } from '@/stores/subscription'
import LoadingSpinner from '@/components/common/LoadingSpinner.vue'
import { CheckIcon, XMarkIcon } from '@heroicons/vue/24/outline'

/**
 * ğŸ“¡ ç»„ä»¶Propså®šä¹‰
 */
interface Props {
  isOpen: boolean          // å¼¹çª—æ˜¾ç¤ºçŠ¶æ€
  selectedPlan?: string    // é€‰ä¸­çš„è®¢é˜…è®¡åˆ’
}

defineProps<Props>()

/**
 * ğŸ”„ ç»„ä»¶Emitså®šä¹‰
 */
const emit = defineEmits<{
  close: []    // å…³é—­å¼¹çª—äº‹ä»¶
  success: []  // è®¢é˜…æˆåŠŸäº‹ä»¶
}>()

// ğŸ“Š è®¢é˜…çŠ¶æ€ç®¡ç†
const subscriptionStore = useSubscriptionStore()

// ğŸ›ï¸ ç»„ä»¶çŠ¶æ€
const isProcessing = ref(false) // æ”¯ä»˜å¤„ç†çŠ¶æ€

// ğŸ’³ æ”¯ä»˜è¡¨å•æ•°æ®
const paymentForm = ref({
  cardNumber: '',   // ä¿¡ç”¨å¡å·
  expiry: '',       // æœ‰æ•ˆæœŸ
  cvc: '',          // CVCå®‰å…¨ç 
  name: ''          // æŒå¡äººå§“å
})

/**
 * âœ… Proç‰ˆåŠŸèƒ½ç‰¹æ€§åˆ—è¡¨
 */
const proFeatures = [
  'Unlimited articles access',
  'Advanced contextual definitions',
  'Sentence-level audio synchronization',
  'Cross-article word search',
  'Detailed learning analytics',
  'Export capabilities (PDF, EPUB)',
  'Priority customer support',
  'No advertisements'
]

/**
 * âœ… æ”¯ä»˜è¡¨å•éªŒè¯çŠ¶æ€
 * æ‰€æœ‰å¿…å¡«å­—æ®µéƒ½æœ‰æ•ˆæ—¶è¡¨å•æ‰æœ‰æ•ˆ
 */
const isPaymentFormValid = computed(() => {
  return paymentForm.value.cardNumber.length >= 16 &&
         paymentForm.value.expiry.length === 5 &&
         paymentForm.value.cvc.length === 3 &&
         paymentForm.value.name.trim().length > 0
})

/**
 * ğŸ’³ ä¿¡ç”¨å¡å·æ ¼å¼åŒ–å‡½æ•°
 * è‡ªåŠ¨æ·»åŠ ç©ºæ ¼åˆ†éš”ï¼Œæ ¼å¼ï¼š1234 5678 9012 3456
 */
const formatCardNumber = (event: Event) => {
  const input = event.target as HTMLInputElement
  let value = input.value.replace(/\s/g, '').replace(/[^0-9]/gi, '')
  const matches = value.match(/\d{4,16}/g)
  const match = matches && matches[0] || ''
  const parts = []

  // æ¯4ä½æ·»åŠ ä¸€ä¸ªç©ºæ ¼
  for (let i = 0, len = match.length; i < len; i += 4) {
    parts.push(match.substring(i, i + 4))
  }

  if (parts.length) {
    paymentForm.value.cardNumber = parts.join(' ')
  } else {
    paymentForm.value.cardNumber = value
  }
}

/**
 * ğŸ“… æœ‰æ•ˆæœŸæ ¼å¼åŒ–å‡½æ•°
 * è‡ªåŠ¨æ·»åŠ æ–œçº¿åˆ†éš”ï¼Œæ ¼å¼ï¼šMM/YY
 */
const formatExpiry = (event: Event) => {
  const input = event.target as HTMLInputElement
  let value = input.value.replace(/\D/g, '')
  
  // åœ¨ç¬¬2ä½åæ·»åŠ æ–œçº¿
  if (value.length >= 2) {
    value = value.substring(0, 2) + '/' + value.substring(2, 4)
  }
  
  paymentForm.value.expiry = value
}

/**
 * ğŸš€ å¤„ç†è®¢é˜…ç¡®è®¤
 * Mockæ”¯ä»˜æµç¨‹ï¼Œæ¨¡æ‹ŸçœŸå®æ”¯ä»˜ä½“éªŒ
 */
const handleSubscribe = async () => {
  if (!isPaymentFormValid.value) return

  isProcessing.value = true

  try {
    // ğŸ­ æ¨¡æ‹Ÿæ”¯ä»˜å¤„ç†å»¶è¿Ÿ
    await new Promise(resolve => setTimeout(resolve, 2000))
    
    // ğŸ² Mockæ”¯ä»˜æˆåŠŸ/å¤±è´¥ï¼ˆ90%æˆåŠŸç‡ï¼‰
    if (Math.random() < 0.9) {
      // æ”¯ä»˜æˆåŠŸ - æ›´æ–°è®¢é˜…çŠ¶æ€
      await subscriptionStore.upgrade('pro_monthly')
      emit('success')
    } else {
      // æ”¯ä»˜å¤±è´¥ - æŠ›å‡ºé”™è¯¯
      throw new Error('Payment failed. Please check your card details and try again.')
    }
  } catch (error) {
    // æ˜¾ç¤ºæ”¯ä»˜é”™è¯¯ä¿¡æ¯
    alert(error instanceof Error ? error.message : 'Payment failed')
  } finally {
    isProcessing.value = false
  }
}
</script>

<style scoped>
/**
 * ğŸ¨ ç»„ä»¶æ ·å¼
 * 
 * ğŸ“‹ ä¸»è¦æ ·å¼:
 * - å¼¹çª—è¿›å…¥/é€€å‡ºè¿‡æ¸¡åŠ¨ç”»
 * - ç¼©æ”¾å’Œé€æ˜åº¦å˜åŒ–
 */

/* å¼¹çª—è¿‡æ¸¡åŠ¨ç”» */
.modal-enter-active,
.modal-leave-active {
  transition: all 0.3s ease;
}

.modal-enter-from,
.modal-leave-to {
  opacity: 0;
  transform: scale(0.9);
}
</style>